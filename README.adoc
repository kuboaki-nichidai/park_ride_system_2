
:encoding: utf-8
:lang: ja
:scripts: cjk
:media: prepress
:linkcss:
:stylesdir: css
:stylesheet: mystyle.css
:sectanchors:
:autofit-option:
:experimental:
:support-uri:
:original-support-uri:
:twoinches: width='360'
:full-width: width='100%'
:three-quarters-width: width='75%'
:two-thirds-width: width='66%'
:half-width: width='50%'
:half-size:
:one-thirds-width: width='33%'
:one-quarters-width: width='25%'
:thumbnail: width='60'
:imagesdir: images
:sourcesdir: codes
:icons: font
:hide-uri-scheme!:
:figure-caption: 図
:example-caption: リスト
:table-caption: 表
:appendix-caption: 付録
:xrefstyle: short
:section-refsig:
:chapter-refsig:


= パークライドシステム

NOTE: この演習は、グループで相談しつつ、各自が実施します。

== 演習場所を調整する


=== EV3RTのワークスペースにcloneする

このAssignmentでは、演習でEV3RTのプログラムをビルド（make）します。
そのため、サンプルコードをEV3RTの開発環境に配置しておかないと不自由です。
そうなるように、cloneする場所を EV3RT のワークスペースとなる場所を調整します。

IMPORTANT: もし、このAssignmentを既に指示と異なる場所にcloneしてしまっていた場合は、指示の場所へ移動しましょう。

具体的には、 `sdk/workspace` の「並び」に配置します。
次のように、 `sdk` ディレクトリに移動してからcloneを実行します。

[[assignment_location01]]
.`sample_code_and_model/` をワークスペースの位置に配置する
[source,shell]
----
$ cd {EV3RTの置き場所}/hrp3/sdk # <1>
$ git clone {受理したこのAssigmentのURL} # <2>
----
<1> EV3RTの `sdk` ディレクトに移動した。WSL2のターミナルであれば  `/mnt/c/ev3rt` や `/mnt/c/Users/アカウント名/ev3rt` などだろう。
<2> 例えばアカウント名が `abcd` なら、 `https://github.com/cit-prjex/sample-code-and-model-abcd.git` のようになるだろう。

`workspace` と同じ階層（ `sdk` の下）に配置されたことを確認します。
例えば、 cloneしたリポジトリが `sample-code-and-model-abcd` ならば、 <<assignment_location02>> のよな配置になります。

[[assignment_location02]]
[source,shell]
.cloneしたリポジトリの配置を確認する
----
$ pwd # <1>
{EV3RTの置き場所}/hrp3/sdk
$ tree -L1
{EV3RTの置き場所}/hrp3/sdk
├── （その他のいろいろ）
├──  {受理したこのAssigmentのディレクトリ} # <2>
└── workspace
----
<1> カレントディレクトリ（現在のディレクトリ）を `sdk` に移動したことを確認。
<2> cloneしたリポジトリ（のディレクトリ）があることを確認する。


=== Makefileをworkspaceからコピーする


`workspace` の中にあるMakefileがないと、EV3RTのワークスペースとして機能しません。
そこで、`workspace` の中の `Makefile` をcloneしたリポジトリにコピーします。
ターミナルから実行してもよいですし、Windows のExploreを使ってコピーしてもかまいません。

[source,shell]
.`Makefile` をコピーできたか確認する
----
$ pwd
{EV3RTの置き場所}/hrp3/sdk/{受理したこのAssigmentのディレクトリ} # <1>
$ ls -1 # <2>
（README.adocなどいろいろ）
Makefile # <3>
----
<1> カレントディレクトリ（現在のディレクトリ）が、cloneしたディレクトリに移動してあることを確認。
<2> `ls` コマンドを `-1` （エルではなく `1` ）で実行した。
<3> Makefileがコピーできていいることを確認した。


=== ビルドできるか確認する

`codes` ディレクトリのコードがビルドできるかどうか、確認します。

`sample01` などが含まれていますから、これらをビルドして `app` が作成できるか確認します。

[[make_sample01]]
.`sample01` をビルドする
[source,shell]
----
$ make app=codes/sample01 # <1>
----
<1> `sample01` があるのは `codes` の中なので、そこを指定してビルドした。

`app` ファイルが作成できていれば（既に合った場合は更新できていれば）、オーケーです（ファイルの日付も確認すること）。

NOTE: もし、 `app` ファイルが作成・更新できない場合には、もう一度、ここまでの手順を確認しましょう。

== モデル図を参照する

=== 【演習】モデル図を参照する

. このAssignmentて提供されているモデル図 `models/park_ride_system.asta` を開いて、内容を確認しなさい。
. 開いたモデル図の構造ツリーを参照し、「04_内部設計＞app＞auto_ride＞run＞auto_ride::runのステートマシン図」を開いている状態のAstahのウィンドウのスナップショットを撮りなさい。
** 左の「構造ツリー」のペインとステートマシン図が表示されている状態の画面を撮る。
. 下の <<park_ride_system_asta_snap>> を撮影したスナップで置き換えなさい。

[NOTE]
--
Windowsでアプリケーションウィンドウのスナップを撮るには、下記記事を参考にするとよいでしょう。

https://tenshoku.mynavi.jp/engineer/guide/articles/YtOpxxAAACEAwCZA
--

[[park_ride_system_asta_snap]]
.`park_ride_system` のAstahの画面（自分が撮ったスナップと差し替える）
image::park_ride_system_asta_snap.png[{half-width}]

== 要求分析

=== 【演習】要求分析のユースケース図を作る

NOTE: ユースケース、ユースケース図について説明や議論が必要なら、グループでレビューを受けなさい。

==== 要求分析のユースケース図を作成しなさい

講義資料で示したパークライドの要件を整理して、  `models/park_ride_system.asta` の「01_要求分析＞要求分析のユースケース図」を編集してユースケース図を作成しなさい。

==== 要求分析のユースケース記述を作成しなさい

講義資料で示したパークライドの要件を整理して、  `models/park_ride_system.asta` の「01_要求分析＞要求分析のユースケース図」に、ノートを使ってユースケース記述を作成しなさい。


==== 作成した要求分析のユースケース図を画像として保存しなさい

作成したユースケース図を「ツール＞画像出力＞現在の図＞PNG」を指定して、下記 <<use_case_01>> を置き換えなさい。

[[use_case_01]]
.`park_ride_system` のユースケース図
image::park_ride_system_use_case_01.png[{half-width}]

=== ここまで（要求分析まで）の成果を保存する


IMPORTANT: ここまでで、作業した文書・図・コード等を保存し、このリポジトリをコミット・プッシュしなさい。

== システム分析

=== 【演習】システム分析について整理する

==== システム分析について確認しなさい

.  `models/park_ride_system.asta` の「02_システム分析＞システム分析のクラス図」を開き、このシステムのドメイン分割について確認しなさい。
** 必要なら、ノートを使って説明を追加しなさい。
. このクラス図の画像を保存し、下記 <<system_anlysis_01>> を置き換えなさい。

[[system_anlysis_01]]
.`park_ride_system` のドメイン分割
image::park_ride_system_system_anlysis_01.png[{half-width}]

.  `models/park_ride_system.asta` の「02_システム分析＞パークライドシステムの方式設計書」を開き、このシステムの開発に使用する実装方式について確認しなさい。
** 必要なら、ノートを使って説明を追加しなさい。
. この図の画像を保存し、下記 <<impl_mechanism_01>> を置き換えなさい。

[[impl_mechanism_01]]
.`park_ride_system` の実装方式
image::park_ride_system_impl_mechanism_01.png[{half-width}]


=== ここまで（システム分析まで）の成果を保存する


IMPORTANT: ここまでで、作業した文書・図・コード等を保存し、このリポジトリをコミット・プッシュしなさい。

== 外部設計

=== 【演習】外部設計の実施

NOTE: クラス図、シーケンス図、外部設計などについて説明や議論が必要なら、グループでレビューを受けなさい。

==== 外部設計のクラス図（一次）を作成しなさい

. `models/park_ride_system.asta` の「03_外部設計＞外部設計のクラス図」を開く。
. クラス図に、要求分析のユースケース図 <<use_case_01>> から、アクターをドラッグして追加しなさい。
** アクターをマウスで選択した状態で右クリックしてポップアップルメニューを表示し、「アイコン表記＞標準」を選択して、表示をアクターアイコンからクラスのシンボルに変更しなさい。
. クラス図に、パークライドシステムを表すクラスを追加しなさい。
** クラス名は `park_ride_system` としましょう。
** 追加したクラスに、プロパティからステレオタイプ `<<system>>` を追加しなさい。
. 追加したパークライドシステムを示すクラスの操作に、要求分析のユースケースを参照して、操作を追加しなさい。
. 必要なら、ノートを使って説明を追加しなさい。
. このクラス図の画像を保存し、下記 <<system_design_class_01>> を置き換えなさい。

[[system_design_class_01]]
.`park_ride_system` の外部設計のクラス図（一次）
image::park_ride_system_system_design_class_01.png[{half-width}]

==== サブシステム分割について検討しなさい（二次）

作ろうとしているシステムが、複数のサブシステム分轄されるかどうか検討します。

次の条件を検討して、サブシステムになるかどうか判断します。

. 開発単位が異なるものが集まっている
** 実行できるプログラムが複数ある場合（たとえば `make` を別々に実施するものがあるなど）は、それらはサブシステムに分けます。
. システム内部で通信する場所がある
** システムの内部にネットワーク、Bluetoothなどを使って、送信する側、受信する側、または送受信する者同士になっている部分があれば、その通信部分でサブシステムに分割します。
. 人や他のシステムが介在している。
** システムの内部で、動作・操作のなかに、システム内の人（サービスを受けるアクターではなく、サービスを提供する側の係員など）がいるときや、そういった立場の別のシステムが、間に入っている場合、その部分でサブシステムに分割します。

検討しているシステムが、サブシステムに分割する必要があるシステムであると判断した場合には、<<system_design_class_01>> を見直して、サブシステムを追加しなさい。


[NOTE]
--
多くのシステムは、サブシステムに分解される場合が多いですが、必ず分轄されると決まっているわけではありません。
分割を検討して、分ける必要がないと判断した場合には、分轄されていない1つのシステムをかいはつすることになります。
--

もし、サブシステムに分割する事になった場合は、サブシステムに分割したクラス図を作成し、その画像を保存し、下記 <<system_design_class_02>> を置き換えなさい。

[[system_design_class_02]]
.サブシステムに分割した `park_ride_system` の外部設計のクラス図（二次）
image::park_ride_system_system_design_class_02.png[{half-width}]

NOTE: サブシステムに分割する必要がないと決定した場合は、 `変更無し.png` を上記ファイル名のファイルとしてコピーして、変更がなかったことを示しなさい。


==== 外部設計のシーケンス図を作成しなさい

外部設計のシーケンス図を作成します。
外部設計のクラス図に登場しているアクターやクラスをタイムラインとして配置し、ユースケース記述で示したやり取りを元に、メッセージを追加しなさい。

もし、検討しているシステムをサブシステムに分轄している場合は、サブシステムをタイムライに配置しなさい。

. `models/park_ride_system.asta` の「03_外部設計＞外部設計の（ユースケースXXの）シーケンス図」を開く。
. 要求分析のユースケース名を参照して、図の名前の「（ユースケースXXの）」の部分を変更しなさい。
** ユースケースが複数ある場合には、シーケンス図はユースケースごとに別の図として作成しなさい。
. ユースケース記述を参照して、アクターとシステムのやり取りを、シーケンス図のメッセージとして作成しなさい。
. 全てのユースケースについて、シーケンス図を作成しなさい。
. このシーケンス図の画像を保存し、下記 <<system_design_seq_01>> を置き換えなさい
** キャプションの `ユースケース名` の部分を作成したユースケース名で置き換えなさい。
** シーケンス図が複数ある場合には、`park_ride_system_system_design_seq_0X.png` （Xは番号））とったファイル名でそれぞれの図を保存しなさい。


[[system_design_seq_01]]
.`park_ride_system` の外部設計のシーケンス図（ユースケース名）
image::park_ride_system_system_design_seq_01.png[{half-width}]

NOTE: シーケンス図が複数ある場合には、README.docの上記部分をコピーして、ここに追加し、それぞれの図の画像ファイル名とキャプションを変更し、各図がこの場所に挿入されるようにしなさい。

==== 外部設計のクラス図（三次）を作成しなさい

作成したシーケンス図を参照して、クラス図（ <<system_design_class_01>> または <<system_design_class_02>> ）を見直しなさい。

. やり取りがあるもの同士に関連の線を引きなさい。
. やり取りがないもの同士の間に関連があれば、それを削除しなさい。
. だれともやり取りがないクラスがあったら、クラス図の端によけて色を変えておきなさい。
. やり取りを、受け取る側の働きとして、受け取る側のクラスの操作として追加しなさい。
. このクラス図の画像を保存し、下記 <<system_design_class_03>> を置き換えなさい。

[[system_design_class_03]]
.`park_ride_system` の外部設計のクラス図（三次）
image::park_ride_system_system_design_class_03.png[{half-width}]



=== ここまで（外部設計まで）の成果を保存する


IMPORTANT: ここまでで、作業した文書・図・コード等を保存し、このリポジトリをコミット・プッシュしなさい。

== 内部設計


=== 【演習】内部設計の実施


NOTE: クラス図、ステートマシン図、内部設計などについて説明や議論が必要なら、グループでレビューを受けなさい。

==== 内部設計の対象を確認する

内部設計の単位は、サブシステムです。
クラス図は、サブシステムごとに作成します。

しかし、外部設計の段階で、`park_ride_system` は、`auto_ride` だけで構成されていました。
つまり、このシステムはサブシステムに分割されていません（1つのサブシステムで構成されているとみなすこともできる）。

そこで、 `auto_ride` をサブシステムに分轄されていないシステムをみなして、内部設計を進めます。

==== 内部設計のクラス図（一次）を作成しなさい

. `models/park_ride_system.asta` の「04_内部設計＞内部設計のクラス図」を開く。
. クラス図に、オートライドに必要なユニットをクラスとして追加しなさい。
** クラス名のつけ方は、`sample04` のクラス図を参考にしなさい。
** どのパッケージに配置すべきか検討したうえで、配置するパッケージを決めなさい。
. 追加したクラスを右クリックして、ポップアップメニューから「その他の表示/非表示＞名前空間＞親」を選択しなさい。
** クラス名が「パッケージ名::クラス名」のように代わったことを確認しなさい。
. 必要なら、ノートを使って説明を追加しなさい。
. このクラス図の画像を保存し、下記 <<detail_design_class_01>> を置き換えなさい。

[[detail_design_class_01]]
.`park_ride_system` の `auto_raide` の内部設計のクラス図（一次）
image::park_ride_system_<detail_design_class_01.png[{half-width}]


==== 振舞いが必要なクラスに操作とステートマシン図を追加しなさい

. `auto_ride` のクラス図にあるクラスのうち、振舞いの設計が必要なクラスに、振舞いのための操作と、ステートマシン図を追加しなさい。
** ステートマシン図は、振舞いのための操作に対して作成ます。
** ステートマシン図の名前は、 `クラス名::操作名のステートマシン図` のように命名します（間を半角のコロンでつなぐ）。

[NOTE]
--
特定の操作に対してステートマシン図を作成した場合、 <<statemachine_and_method_01>> のように、構造ツリーに反映されます。

[[statemachine_and_method_01]]
.操作に対して割り当てられたステートマシン図の例
image::statemachine_and_method.png[]
--


==== 振舞いを実現するステートマシン図を作成しなさい

NOTE: そのとき、クラス図にクラスや操作が不測する場合は、クラス図に戻って追加・修正しなさい。

. 外部設計のシーケンス図、要求分析のユースケース記述、などを参照しながら、操作を実現する状態遷移を追加します。
** アクション（イベントチェックや状態内の処理）に必要な操作があればそれを使います。
** そのクラスや、関連づけられている（関連の線が引かれている）クラスにないときは、クラス図に戻って必要なクラスや操作を追加します。
. アクションやイベントに説明が必要な場合は、ノートをつけて補足します。
** たとえば、イベント「側壁が見つかった」のせつめいとして「配達先に着いたとみなす」という説明を加えた場合など。
. このステートマシン図の画像を保存し、下記 <<detail_design_stm_01>> を置き換えなさい。
. もとのクラス図を更新している場合には画像を保存し、下記 <<detail_design_class_01>> を置き換えなさい。

[[detail_design_stm_01]]
.`park_ride_system` の `auto_raide` の内部設計のステートマシン図
image::park_ride_system_detail_design_stm_01.png[{half-width}]

[[detail_design_class_01]]
.`park_ride_system` の `auto_raide` の内部設計のクラス図（ステートマシン図といっしょに更新）
image::park_ride_system_<detail_design_class_01.png[{half-width}]

=== ここまで（内部設計まで）の成果を保存する


IMPORTANT: ここまでで、作業した文書・図・コード等を保存し、このリポジトリをコミット・プッシュしなさい。


== 実装


=== 【演習】実装

NOTE: クラス図やステートマシン図と実装の対応づけについて説明や議論が必要なら、グループでレビューを受けなさい。


==== 内部設計と実装方式を確認する


* 内部設計のクラス図とステートマシン図を参照して、構成要素や振舞いが、これらの図と対応するように実装する。
* 「sample_code_and_model」で実践した実装方式に従って、コードを作成する。

==== 実装は段階的に進める

* すべてを実装してからテストすると、たいてい動かない
** 更新箇所がたくさんあるので、問題が起きている箇所が複数ある
** 問題が別の問題に影響を与えている場合も混じった状況になる
** すぐに修正して、動作できるようにならない
** 動かないので、内部設計や変換ルールを無視して修正してしまいがち
* 段階的に実装する
** 最低限必要な準備をして、動作を確認する
** **主な処理を担うステートマシン図を見ながら、１状態分を実装する**
** 実装したら動作を確認する
** 動作したら、次の状態の実装へ進む
** うまく行かない状況が見つかったら、内部設計に戻って修正・追加する


== テスト


=== 【演習】実行した結果と設計内容を比較する

NOTE: クラス図やステートマシン図と実装の対応づけについて説明や議論が必要なら、グループでレビューを受けなさい。

. 内部設計のステートマシン図から、テストケースとなるイベント列を検討する。
** 状態遷移のパスをたどると、イベント列が得られる。それをテストケースとして、テストを実施する。

==== ステートマシンを持つクラスのテスト方法

. 内部設計のクラスのステートマシン図からテストケースを作る
** ステートマシンを担当するメソッドが対象
. ステートマシン図の状態遷移を巡る経路をテストケースにする
** 循環（ループする状態遷移）があるときは、テストケースを分ける
*** ループを通らないケース
*** ループを1度だけ通るケース
*** ループを2度以上通るケース
. テストの入力
** イベントの列（場合によっては発生間隔、発生時刻を伴う）
** テスト結果、判定方法
** イベントが起きたときのアクションが観測可能とは限らない
** 観測可能な振舞い（アクションの副作用）や動作の出力を結果にする

NOTE: 観測可能なアクションとは、音が鳴る、動く、表示が変わる、ログに書き込まれる、期待値とマッチするなど。

==== ステートマシン図からテストケースを作る

* 状態遷移のパスの選択でテストケースを分ける（ <<test_case_study>> ）
* 期待しないイベントが起きるケースも検討する
** 無視するのか、起きるのがおかしいなら障害を検出できるか
** S1において、 e1, e2 以外のイベントを与えるケース

[[test_case_study]]
.ステートマシン図からテストケースのイベント列を考える
image::test_case_study.png[{half-width}]


=== ここまで（実装まで）の成果を保存する


IMPORTANT: ここまでで、作業した文書・図・コード等を保存し、このリポジトリをコミット・プッシュしなさい。


== プロセスを繰り返す


=== プロセスの改変ごとに成果を保存する


IMPORTANT: 修正・変更・追加した文書・図・コード等があれば、その都度、成果物を保存し、このリポジトリをコミット・プッシュしなさい。
